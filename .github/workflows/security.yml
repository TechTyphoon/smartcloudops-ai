name: Security & Compliance Monitoring

on:
  # Run security scans on schedule
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  # Allow manual security scans
  workflow_dispatch:
  # Scan on security-sensitive changes
  push:
    paths:
      - 'requirements*.txt'
      - 'Dockerfile*'
      - 'app/**'
      - '.github/workflows/**'
      - 'terraform/**'
      - 'k8s/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'requirements*.txt'
      - 'Dockerfile*'
      - 'app/**'
      - 'terraform/**'
      - 'k8s/**'

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/smartcloudops
  PYTHON_VERSION: "3.11"

jobs:
  # =====================================================
  # 🔒 COMPREHENSIVE SECURITY AUDIT
  # =====================================================
  security-audit:
    name: 🔒 Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: 🐍 Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements*.txt'
        
    - name: 📦 Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        pip install -r requirements.txt
        
    - name: 🔍 Basic security scan (Bandit)
      run: |
        echo "::group::Python security scan"
        bandit -r app/ -f json -o bandit-results.json || true
        bandit -r app/ --severity-level high --skip B104 || echo "Security issues found, but continuing..."
        echo "::endgroup::"
      continue-on-error: true
        
    - name: 🔒 Deep Bandit scan
      run: |
        echo "::group::Deep Python security scan"
        bandit -r app/ -f json -o bandit-deep.json || true
        bandit -r app/ --severity-level low --confidence-level medium || echo "Deep security scan issues found, but continuing..."
        echo "::endgroup::"
      continue-on-error: true
        
    - name: 🛡️ Comprehensive dependency check
      run: |
        echo "::group::Dependency vulnerabilities"
        safety scan --json > safety-comprehensive.json || true
        safety scan --full-report || echo "Some vulnerabilities found, but continuing..."
        echo "::endgroup::"
      continue-on-error: true
        
    - name: 🔍 Secret scanning
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      continue-on-error: true
        
    - name: 📤 Upload security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: comprehensive-security-scan-${{ github.run_number }}
        path: |
          bandit-deep.json
          safety-comprehensive.json
        retention-days: 90

  # =====================================================
  # 🔍 DEPENDENCY REVIEW
  # =====================================================
  dependency-review:
    name: 🔍 Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
      
    - name: 🔍 Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC
        
  # =====================================================
  # 🐳 DOCKER SECURITY SCAN
  # =====================================================
  docker-security:
    name: 🐳 Docker Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
      
    - name: 🏗️ Build Docker image
      run: |
        # Check if Dockerfile.production exists, otherwise use Dockerfile
        if [ -f "Dockerfile.production" ]; then
          DOCKERFILE="Dockerfile.production"
        else
          DOCKERFILE="Dockerfile"
        fi
        echo "Building Docker image using $DOCKERFILE"
        docker build -f $DOCKERFILE -t security-scan:latest . || echo "Docker build failed, but continuing..."
      continue-on-error: true
        
    - name: 🔍 Docker security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'security-scan:latest'
        format: 'sarif'
        output: 'docker-security.sarif'
      continue-on-error: true
        
    - name: 📤 Upload Docker scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('docker-security.sarif') != ''
      with:
        sarif_file: 'docker-security.sarif'

  # =====================================================
  # 🏗️ INFRASTRUCTURE SECURITY
  # =====================================================
  infrastructure-security:
    name: 🏗️ Infrastructure Security
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
      
    - name: 🔧 Setup tools
      run: |
        # Install terraform security scanners
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash || echo "tfsec installation failed, but continuing..."
        
    - name: 🔍 Terraform security scan
      run: |
        echo "::group::Terraform security scan"
        if command -v tfsec &> /dev/null; then
          tfsec terraform/ --format=json --out=tfsec-results.json || true
          tfsec terraform/ || echo "Terraform security issues found, but continuing..."
        else
          echo "tfsec not available, skipping Terraform security scan"
        fi
        echo "::endgroup::"
      continue-on-error: true
        
    - name: 🔍 Kubernetes security scan
      run: |
        echo "::group::Kubernetes manifests security"
        # Install kubesec
        wget https://github.com/controlplaneio/kubesec/releases/latest/download/kubesec_linux_amd64.tar.gz || echo "kubesec download failed, but continuing..."
        tar -xzf kubesec_linux_amd64.tar.gz || echo "kubesec extraction failed, but continuing..."
        
        # Scan k8s manifests
        if [ -d "k8s" ]; then
          for file in k8s/*.yaml; do
            if [ -f "$file" ]; then
              echo "Scanning $file"
              ./kubesec scan "$file" || echo "kubesec scan failed for $file, but continuing..."
            fi
          done
        else
          echo "k8s directory not found, skipping Kubernetes security scan"
        fi
        echo "::endgroup::"
      continue-on-error: true
        
    - name: 📤 Upload infrastructure scan results  
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: infrastructure-security-${{ github.run_number }}
        path: |
          tfsec-results.json
        retention-days: 90

  # =====================================================
  # 📊 SECURITY SUMMARY & NOTIFICATION
  # =====================================================
  security-summary:
    name: 📊 Security Summary
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-review, docker-security, infrastructure-security]
    if: always()
    
    steps:
    - name: 📊 Generate security summary
      run: |
        echo "::group::Security Scan Summary"
        echo "Security Audit: ${{ needs.security-audit.result }}"
        echo "Dependency Review: ${{ needs.dependency-review.result }}"
        echo "Docker Security: ${{ needs.docker-security.result }}"
        echo "Infrastructure Security: ${{ needs.infrastructure-security.result }}"
        echo "::endgroup::"
        
    - name: 📤 Upload security summary
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-summary-${{ github.run_number }}
        path: |
          bandit-results.json
          safety-comprehensive.json
          docker-security.sarif
          tfsec-results.json
        retention-days: 90
